{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block title %}Profile Page{% endblock %}

{% block content %}
<link rel= "stylesheet" type= "text/css" href= "../static/styles/style.css">
<link rel= "stylesheet" type= "text/css" href= "../static/styles/profile.css">

<!-- JavaScript for Multiselect Dropdown -->
<script type="text/javascript" src="{% static 'js/multiselect-dropdown.js' %}"></script>


{% if messages %}
<div class="alert alert-success">
    {% for message in messages %}
        {{ message }}
    {% endfor %}
</div>
{% endif %}

<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="content-container">
        <div class="pfp-container">
            <div class="pfp">
                <img 
                    id="profileImage" 
                    src="{% if profile.picture %}{{ profile.picture.url }}{% else %}https://via.placeholder.com/150{% endif %}" 
                    alt="Profile Picture"
                    style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 2px solid #D9D9D9;"
                >
                <button 
                    type="button" 
                    class="upload-btn" 
                    onclick="document.getElementById('id_picture').click();"
                >
                    Edit Photo
                </button>
            </div>
        
            <div class="mb-3" style="display:none;">
                <input 
                    type="file" 
                    id="id_picture" 
                    name="picture" 
                    accept="image/*" 
                    class="form-control-file"
                    onchange="previewImage(event)"
                >
            </div>
        </div>


        <div class="info-container">
            <h2 style="grid-column: 1/3;">Personal Information</h2>

                
            <div class="mb-3">
                <label for="id_name">Name<span style="color:red">*</span></label>
                <input 
                    type="text" 
                    class="form-control" 
                    name="name" 
                    value="{{ form.name.value|default:user.get_full_name }}" 
                >
            </div>
            

            <div class="mb-3">
                <label for="id_username">Username</label>
                <div class="readonly-field">{{ profile.username }} </div>
            </div>

            <div class="mb-3">
                <label>BC Email</label>
                <div class="readonly-field">{{ profile.bc_email }}</div>
            </div>

            <div class="mb-3">
                <label for="id_school">School<span style="color:red">*</span></label>
                {% render_field form.school class="form-select" %}
            </div>

            <div class="mb-3">
                <label for="id_major">Major(s)<span style="color:red">*</span></label>
                {% render_field form.major class="form-control multiselect-target" multiselect-search="true" multiselect-max-items="2" %}
            </div>
            

            <div class="mb-3">
                <label for="id_minor">Minor(s)</label>
                {% render_field form.minor class="form-control multiselect-target" multiselect-search='true' %}
            </div>

            <div class="mb-3">
                <label for="id_graduation_year">Graduation Year<span style="color:red">*</span></label>
                {% render_field form.graduation_year class="form-select" %}
            </div>

            <label>
                <span style="color:red">*</span>Required field
            </label>
        </div>

        <div class="notification-container">
            <h2>Notifications</h2>
        </div>

        <div class="bottom-containers">
            <div class="bio-container">
                <label for="id_bio"><h2>Bio</h2></label>
                {% render_field form.bio class="form-control" placeholder="Letâ€™s get sustainable!" %}
            </div>
    
            <div class="submit-container">
                <button type="submit" class="btn btn-primary mt-3">Save</button>
            </div>
        </div>
    </div>
</form>

<script>
    function previewImage(event) {
        const reader = new FileReader();  // Create a new FileReader instance
        const imageField = document.getElementById('profileImage');  // Get the image element
        const majorField = document.querySelector('[name="major"]');
        const minorField = document.querySelector('[name="minor"]');

        // Set custom attributes for multiselect functionality
        majorField.setAttribute('multiselect-search', 'true');
        majorField.setAttribute('multiselect-max-items', '2');
        minorField.setAttribute('multiselect-search', 'true');

        // Initialize multiselect dropdown
        MultiselectDropdown(window.MultiselectDropdownOptions);

        reader.onload = function () {
            if (reader.readyState === 2) {  // File is fully read
                imageField.src = reader.result;  // Set the src to the selected image
            }
        };

        reader.readAsDataURL(event.target.files[0]);  // Read the selected file
    }
</script>

{% endblock %}
