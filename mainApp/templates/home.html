{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'styles/style.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'styles/home.css' %}">
<div class="landing-page-container">
    <div class="leaderboard-container">
        <h2 class="section-title">Leaderboard</h2>
        <div class="chart-container">
            <canvas id="leaderboardChart"></canvas>
        </div>
        <div class="user-rank">
            <p class="motivation-container">You are ranked {{ user_rank }} out of {{ total_users }}. {{ motivation_message }}</p>
        </div>
        <div class="leaderboard-table-container">
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Place</th>
                        <th>Name</th>
                        <th class="points-column">Points</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in leaderboard_data %}
                    <tr>
                        <td>
                            <span class="rank-icon">
                                {% if user.rank_change > 0 %}
                                <span class="rank-up">▲</span> <!-- Green up arrow for rank increase -->
                                {% elif user.rank_change < 0 %} <span class="rank-down">▼</span>
                            <!-- Red down arrow for rank decrease -->
                            {% else %}
                            <span class="rank-neutral">●</span> <!-- Neutral icon for no change -->
                            {% endif %}
                            </span>
                            {{ forloop.counter }}
                        </td>
                        <td>
                            <img src="{% if user.picture %}{{ user.picture.url }}{% else %}{% static 'images/default_profile_image.jpg' %}{% endif %}"
                                alt="Profile image" class="profile-image">
                            {{ user.name }}
                        </td>
                        <td class="points-column">{{ user.points }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="latest-news">
        <h2 class="section-title">Latest News</h2>
        <p class="paragraph-font">
            Be sustainable today! Check out what’s happening in the community and take part in sustainable events,
            activities, and promotions.
        </p>
        <ul class="no-bullets">
            <!-- First check if there are any campaigns to display -->
            {% for campaign in campaign_items %}
                {% if campaign.news%}
                <li class="news-item">
                    <div class="news-box">
                        <a href="{% url 'actions' %}" target="_blank">{{ campaign.title }}</a>
                    </div>    
                </li>
                {% endif%}
            {% endfor%}
            <!-- Then display news items -->
            {% for news in news_items %}
                {% if news.external_url %}
                    <li class="news-item">
                        <div class="news-box">
                            {% if news.news_image %}
                                <img src="{{ news.news_image.url }}">
                            {% endif %}
                            <a href="{{ news.external_url }}" target="_blank">{{ news.display_title }}</a>
                        </div>    
                    </li>
                {% endif %}
            {% endfor %}
        </ul>
    </div>
</div>
<!-- barchart -->
<div class="chart-container">
    <canvas id="leaderboardChart"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const top3Names = JSON.parse('{{ top_3_names|escapejs }}');
        const top3Points = JSON.parse('{{ top_3_points|escapejs }}');
        const ctx = document.getElementById('leaderboardChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: top3Names,
                datasets: [{
                    label: 'Points',
                    data: top3Points,
                    backgroundColor: ['#FFD700', '#C0C0C0', '#CD7F32'],
                    borderColor: ['#FFD700', '#C0C0C0', '#CD7F32'],
                    borderWidth: 1,
                }]
            },
            options: {
                maintainAspectRatio: false, 
                plugins: {
                    datalabels: {
                        display: true,
                        color: '#000',
                        font: {
                            weight: 'bold'
                        },
                        formatter: function (value) {
                            return value;
                        }
                    }
                },
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });
</script>
{% endblock %}